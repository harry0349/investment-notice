name: Investment Notice

on:
  schedule:
    # ä¸´æ—¶ä¿®æ”¹ï¼šæ¯ä¸ªå·¥ä½œæ—¥ä¸‹åˆ1:45 (UTCæ—¶é—´) - åŒ—äº¬æ—¶é—´æ™šä¸Š9:45
    - cron: "45 13 * * 1-5"
    # ä¸´æ—¶ä¿®æ”¹ï¼šæ¯å‘¨äº”ä¸‹åˆ1:45 (UTCæ—¶é—´ï¼Œé¢å¤–æ‰§è¡Œå‘¨æ€»ç»“)
    - cron: "45 13 * * 5"
    # ä¸´æ—¶ä¿®æ”¹ï¼šæ¯æœˆæœ€åä¸‰å¤©ä¸‹åˆ1:45 (UTCæ—¶é—´ï¼Œè¦†ç›–æœˆæœ«å·¥ä½œæ—¥)
    - cron: "45 13 28-31 * *"
  workflow_dispatch:

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Build project
        run: cargo build --release

      - name: Format code
        run: cargo fmt --check

      - name: Run Clippy
        run: cargo clippy -- -D warnings

      - name: Run tests
        run: cargo test

      - name: Determine analysis mode
        id: mode
        run: |
          # è·å–å½“å‰æ—¥æœŸä¿¡æ¯
          DAY_OF_MONTH=$(date +%d)
          DAY_OF_WEEK=$(date +%u)  # 1=Monday, 7=Sunday

          echo "Day of month: $DAY_OF_MONTH"
          echo "Day of week: $DAY_OF_WEEK"

          # åˆ¤æ–­è¿è¡Œæ¨¡å¼
          if [ "$DAY_OF_WEEK" = "5" ]; then
            # å‘¨äº”ï¼šè¿è¡Œæ¯å‘¨åˆ†æ
            echo "mode=weekly" >> $GITHUB_OUTPUT
            echo "Running weekly analysis"
          elif [ "$DAY_OF_MONTH" -ge 28 ] && [ "$DAY_OF_WEEK" -le 5 ]; then
            # æœˆæœ«å·¥ä½œæ—¥ï¼šè¿è¡Œæ¯æœˆåˆ†æ
            echo "mode=monthly" >> $GITHUB_OUTPUT
            echo "Running monthly analysis"
          else
            # æ™®é€šå·¥ä½œæ—¥ï¼šè¿è¡Œæ¯æ—¥åˆ†æ
            echo "mode=daily" >> $GITHUB_OUTPUT
            echo "Running daily analysis"
          fi

      - name: Run Investment Analysis
        env:
          TUSHARE_TOKEN: ${{ secrets.TUSHARE_TOKEN }}
          ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER || 'smtp.gmail.com' }}
          SMTP_PORT: ${{ secrets.SMTP_PORT || '587' }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
          TO_EMAILS: ${{ secrets.TO_EMAILS }}
          RUST_LOG: info
        run: |
          echo "Running analysis in ${{ steps.mode.outputs.mode }} mode"
          cargo run --release -- --mode ${{ steps.mode.outputs.mode }} --send-email

  notify-on-failure:
    runs-on: ubuntu-latest
    needs: analyze
    if: failure()

    steps:
      - name: Send failure notification
        uses: actions/github-script@v7
        with:
          script: |
            const { Octokit } = require('@octokit/core');
            const octokit = new Octokit({ auth: process.env.GITHUB_TOKEN });

            // Get the current run information
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });

            // Create an issue if one doesn't exist, or comment on existing
            try {
              // Try to create comment on an issue (if workflow was triggered by issue)
              if (context.issue) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: `ğŸš¨ æŠ•èµ„åˆ†æä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼\n\n**å·¥ä½œæµè¿è¡Œ**: ${run.data.html_url}\n\nè¯·æ£€æŸ¥ä¸Šè¿°é“¾æ¥ä¸­çš„è¯¦ç»†æ—¥å¿—ã€‚`
                });
              }
            } catch (error) {
              console.log('Could not create issue comment:', error.message);
            }
